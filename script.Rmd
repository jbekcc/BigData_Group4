---
title: "Gun vs Vehicle Deaths"
author: "Mike Chirico mchirico@gmail.com"
output:
  html_document:
    fig_width: 8
    number_sections: no
    theme: united
    highlight: tango
    toc: yes
---
## Summary

The data seems to contradict what you read in the media:

1.	Gun related deaths outnumber vehicle deaths.
2.	White race related gun deaths are the highest.
3.	White race and gun deaths seem somewhat correlated with vehicle deaths.

A few things to note: Whites in the 50+ age group, may make up the 
largest part of the population. [kaggle: 2013 American Community Survey](https://www.kaggle.com/mchirico/d/census/2013-american-community-survey/population-by-age-and-race)


Also note the following two ICD10codes:

1.	 Icd10Code x74 
   Description:  “Intentional self-harm by other 
  and unspecified firearm discharge.”  If you jump to the bottom, 
  you’ll see that there are 12,921 deaths that fit this classification. 
2.	 The 2nd total highest Icd10Code is X95 
   Description: “Assault by other and unspecified firearm discharge.”




## Running the Analysis

Below taking a look at Gun vs. Vehicle deaths by age.


```{r, warning=FALSE, message=FALSE}
library(ggplot2)
library(RSQLite)
library(scales)
library(dplyr)
library(tidyr)
library(knitr)

library(DT)

db <- dbConnect(dbDriver("SQLite"), "../input/database.sqlite")

query <-paste("

select 
    v.Age,v.Total Vehicle_Total ,v.White Vehicle_White,
    v.Black Vehicle_Black,v.All_Other  Vehicle_Other,
    g.Total Gun_Total,
    g.White Gun_White,g.Black Gun_Black,g.All_Other Gun_Other
from (
  select 
      Age,count(*) Total ,sum(Race == 1) as White, 
      sum(Race == 2) as Black, sum(Race >=3 or   Race == 0) All_Other
   from DeathRecords d,
     (
     select 
       distinct e.DeathRecordId as id 
       from 
         EntityAxisConditions e,
         (
            select * 
            from Icd10Code where Description like ('%vehicle%')
 
         ) as c 
        where e.Icd10Code = c.code) as f
    where d.id = f.id and AgeType = 1 
    group by Age
    ) as v, -- Vehicle

(
 select 
     Age,count(*) Total ,sum(Race == 1) as White, 
     sum(Race == 2) as Black, sum(Race >=3 or   Race == 0) All_Other
   from DeathRecords d,
       (select 
           distinct e.DeathRecordId as id 
           from 
              EntityAxisConditions e,
              (

        -- Every Firearm discharge, except Legal intervention
        select 
           Code,Description 
           from Icd10Code
           where description like '%discharge%' 
             and description not in  ('Urethral discharge',
             'Discharge of firework',
             'Legal intervention involving firearm discharge')
 
              ) as c 
        where e.Icd10Code = c.code) as f
    where d.id = f.id and AgeType = 1 
    group by Age
    ) as g
     where g.Age = v.Age
     -- End of SQL
")

allVehicleGun <- dbGetQuery(db, query)

# -- Just Look at Totals
data <- select(allVehicleGun, Vehicle_Total,Gun_Total,Age) %>% 
          gather(Group,Deaths,-Age) 

g <- ggplot(dat = data, 
       aes(x=Age, y=Deaths)) + 
      geom_line(aes(colour=Group, group=Group)) + 
      geom_point(aes(colour=Group, shape=Group, group=Group), size=1)+
  ggtitle("Gun vs. Vehicle Deaths\nby Age")

```
### Graph of Guns vs. Vehicle

The graph below is interesting. Note the 2nd jump in deaths, after
age 50.

```{r}
# Show plot
g


```


### Race

Let's further subdivide this by race. And this is where
it starts to get interesting.

```{r}

# Let's see where the jump is coming from.

data <- select(allVehicleGun, Vehicle_White,Vehicle_Black,
               Gun_White,Gun_Black,Age) %>% 
               gather(Group,Deaths,-Age) 

ggplot(dat = data, 
       aes(x=Age, y=Deaths)) + 
      geom_line(aes(color=Group, group=Group)) + 
      geom_point(aes(color=Group, shape=Group, group=Group), size=1)+
  ggtitle("Gun vs. Vehicle Deaths\nby Age and Race")



```


### Close Look at the Numbers

Let's take a close look at the numbers. It might help
to see this in table form. 

```{r}
# Look at the numbers
datatable(allVehicleGun, class = 'compact')
```


```{r}

db <- dbConnect(dbDriver("SQLite"), "../input/database.sqlite")

query <-paste("

select *

from (

select Icd10Code,count(*) count from 

( -- Put the whole previous query block in here

 select distinct d.id
   from DeathRecords d,
     (select distinct e.DeathRecordId as id from 
     EntityAxisConditions e,
     (

     -- Every Firearm discharge, except Legal intervention
    select Code,Description from Icd10Code
     where description like '%discharge%' 
     and description not in  ('Urethral discharge','Discharge of firework',
     'Legal intervention involving firearm discharge')
 
   ) as c 
  where e.Icd10Code = c.code) as f
  where d.id = f.id and AgeType = 1 

  -- End of big query block
) as s

,DeathRecords d
where s.id=d.id
group by Icd10Code order by count desc


) as a,
Icd10Code b where
a.Icd10Code = b.code limit 10

")

vData <- dbGetQuery(db, query)

```
### Top Icd10Codes

See the table below for an explaination of the top
ICD10codes.  Please note the top 2 codes, and the
count (total number of deaths) for each entry.  

The top code X74, list 'Intentional self-harm..', which we'll assume is
suicide.



```{r}

# This might explain why the results seem odd.
# Note the category 'Intentional self-harm by other and unspecified firearm discharge'
kable(vData)




```



## Explaination:

X74 – “Intentional self-harm by other and unspecified firearm discharge" is skewing the results. You can see in the graph below W_X74 (Race White) compared to B_X74 (Race Black) the differences.  



```{r}

db <- dbConnect(dbDriver("SQLite"), "../input/database.sqlite")

query <-paste("


select Age,count(*) Total ,sum(Race == 1) as White, 
  sum(Race == 2) as Black, sum(Race >=3 or   Race == 0) All_Other,
  sum(Race == 1 and Icd10Code == 'X74')  W_X74,
  sum(Race == 2 and Icd10Code == 'X74')  B_X74,

  sum(Race == 1 and Icd10Code == 'X95')  W_X95,
  sum(Race == 2 and Icd10Code == 'X95')  B_X95,

  sum(Race == 1 and Icd10Code == 'X72')  W_X72,
  sum(Race == 2 and Icd10Code == 'X72')  B_X72,

  sum(Race == 1 and Icd10Code == 'X73')  W_X73,
  sum(Race == 2 and Icd10Code == 'X73')  B_X73,

  sum(Race == 1 and Icd10Code == 'X93')  W_X93,
  sum(Race == 2 and Icd10Code == 'X93')  B_X93,

  sum(Race == 1 and Icd10Code == 'X94')  W_X94,
  sum(Race == 2 and Icd10Code == 'X94')  B_X94





 from DeathRecords d,
   (select distinct e.DeathRecordId as id from 
   EntityAxisConditions e,
   (

   select Code,Description from Icd10Code
   where description like '%discharge%' 
   and description not in  ('Urethral discharge','Discharge of firework',
   'Legal intervention involving firearm discharge')
 
   
 
   ) as c 
  where e.Icd10Code = c.code) as f
  where d.id = f.id and AgeType = 1 
 group by Age;

")

v2Data <- dbGetQuery(db, query)

data <- select(v2Data, W_X74,B_X74,
               Age) %>% 
  gather(Group,Total,-Age) 

g <- ggplot(dat = data, 
       aes(x=Age, y=Total)) + 
      geom_line(aes(color=Group, group=Group)) + 
      geom_point(aes(color=Group, shape=Group, group=Group), size=1)+
  ggtitle("X74 - Intentional self-harm by other\n and unspecified firearm discharge\nby Age")

```
### Graph of X74

Here's the actual graph of X74.  You can see the impact.


```{r}
# Display graph
g

```

### Listing the Table


```{r}


# Here's more detail
kable(v2Data)





```





